<!--

  Indigo nodes for IBM's Node-Red
  https://github.com/pdmangel/node-red-contrib-indigo
  (c) 2017, Peter De Mangelaere <peter.demangelaere@gmail.com>

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

-->
<script type="text/x-red" data-template-name="indigo-controller">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-config-input-protocol"><i class="fa fa-unlock-alt"></i> Protocol</label>
    	<select id="node-config-input-protocol" name="node-config-input-protocol" style="width: 250px;">
			<option value="http">http</option>
			<!--<option value="https">https</option>-->
    	</select>
    </div>
    <div class="form-row">
        <label for="node-config-input-host"><i class="fa fa-globe"></i> Host</label>
        <input type="text" id="node-config-input-host">
    </div>
    <div class="form-row">
        <label for="node-config-input-port"><i class="icon-bookmark"></i> Port</label>
        <input type="text" id="node-config-input-port">
    </div>
   
    <div class="form-row">
        <label for="node-config-input-username"><i class="fa fa-user"></i> Username</label>
        <input type="text" id="node-config-input-username">
    </div>
    <div class="form-row">
        <label for="node-config-input-password"><i class="fa fa-user-secret"></i> Password</label>
        <input type="password" id="node-config-input-password">
    </div>

</script>

<script type="text/x-red" data-template-name="indigo-in">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-controller"><i class="fa fa-globe"></i> Controller</label>
        <input type="text" id="node-input-controller">
    </div>
    <div class="form-row">
        <label for="node-input-itemname"><i class="fa fa-crosshairs"></i> ItemName</label>
    	<select id="node-input-itemname" name="node-input-itemname" style="width: 250px;">
    	</select>
    </div>
</script>

<script type="text/x-red" data-template-name="indigo-get-device">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-controller"><i class="fa fa-globe"></i> Controller</label>
        <input type="text" id="node-input-controller">
    </div>
    <div class="form-row">
        <label for="node-input-itemname"><i class="fa fa-crosshairs"></i> ItemName</label>
    	<select id="node-input-itemname" name="node-input-itemname" style="width: 250px;">
    	</select>
    </div>
</script>
<script type="text/x-red" data-template-name="indigo-get-variable">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-controller"><i class="fa fa-globe"></i> Controller</label>
        <input type="text" id="node-input-controller">
    </div>
    <div class="form-row">
        <label for="node-input-itemname"><i class="fa fa-crosshairs"></i> ItemName</label>
    	<select id="node-input-itemname" name="node-input-itemname" style="width: 250px;">
    	</select>
    </div>
</script>
<script type="text/x-red" data-template-name="indigo-exec-action">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-controller"><i class="fa fa-globe"></i> Controller</label>
        <input type="text" id="node-input-controller">
    </div>
    <div class="form-row">
        <label for="node-input-itemname"><i class="fa fa-crosshairs"></i> ItemName</label>
    	<select id="node-input-itemname" name="node-input-itemname" style="width: 250px;">
    	</select>
    </div>
</script>
<script type="text/x-red" data-template-name="indigo-set-device">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-controller"><i class="fa fa-globe"></i> Controller</label>
        <input type="text" id="node-input-controller">
    </div>
    <div class="form-row">
        <label for="node-input-itemname"><i class="fa fa-crosshairs"></i> ItemName</label>
    	<select id="node-input-itemname" name="node-input-itemname" style="width: 250px;">
    	</select>
    </div>
    <div class="form-row">
        <label for="node-input-key"><i class="fa fa-tag"></i> Key</label>
        <input type="text" id="node-input-key" placeholder="Key">
    </div>
</script>
<script type="text/x-red" data-template-name="indigo-set-variable">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-controller"><i class="fa fa-globe"></i> Controller</label>
        <input type="text" id="node-input-controller">
    </div>
    <div class="form-row">
        <label for="node-input-itemname"><i class="fa fa-crosshairs"></i> ItemName</label>
    	<select id="node-input-itemname" name="node-input-itemname" style="width: 250px;">
    	</select>
    </div>
</script>


<script type="text/x-red" data-help-name="indigo-controller">
    <p>Configuration node for communication with an Indigo controller.</p>
	<p></p>
	<b>Configuration</b>
    <ul>
        <li><b>Name :</b> Specify a name for the configuration node</li>
        <li><b>Protocol :</b> "http" or "https"</li>
        <li><b>Host :</b> Specify the hostname or ip address</li>
        <li><b>Port :</b> (Optionally) Specify the ip port</li>
        <li><b>Username :</b> (Optionally) Specify the username to authenticate</li>
        <li><b>Password :</b> (Optionally) Specify the password to authenticate</li>
   	 </ul>
</script>

<script type="text/x-red" data-help-name="indigo-in">
    <p>Listens to state changes of a selected Indigo Item.</p>
	<p></p>
	<b>Configuration</b>
    <ul>
        <li><b>Name :</b> Optionally specify a name</li>
        <li><b>Controller :</b> Select the Indigo controller</li>
        <li><b>Item :</b>Select the Item to monitor</li>
   	 </ul>
	<p></p>

	<b>Messages injected in NodeRED flows (2 channels)</b>
    <ul>
        <li>Channel 1 :
			<ul>
        		<li><code>msg.item</code> : the item's itemname (not label)</li>
        		<li><code>msg.topic</code> : "StateEvent"</li>
        		<li><code>msg.payload</code> : the new state of the selected item</li>
  	 		</ul>
		</li>


   	 </ul>
</script>

<script type="text/x-red" data-help-name="indigo-get-device">
    <p>Gets an Indigo Item on an input message.</p>
	<p></p>
	<b>Configuration</b>
    <ul>
        <li><b>Name :</b> Optionally specify a name</li>
        <li><b>Controller :</b> Select the Indigo controller</li>
        <li><b>Item :</b> Optionally select the Item to address. If specified, it overrides the item specified in the incoming message.</li>
   	 </ul>
	<p></p>

	<b>Messages injected in NodeRED flows (1 channel)</b>
	The input message with addition of :
    <ul>
        <li><code>msg.payload</code> : the item object (name, label, state, ...)</li>
         <li><code>msg.payload_in</code> : copy of incoming message's payload</li>
  	</ul>
</script>
<script type="text/x-red" data-help-name="indigo-get-variable">
    <p>Gets an Indigo Item on an input message.</p>
	<p></p>
	<b>Configuration</b>
    <ul>
        <li><b>Name :</b> Optionally specify a name</li>
        <li><b>Controller :</b> Select the Indigo controller</li>
        <li><b>Item :</b> Optionally select the Item to address. If specified, it overrides the item specified in the incoming message.</li>
   	 </ul>
	<p></p>

	<b>Messages injected in NodeRED flows (1 channel)</b>
	The input message with addition of :
    <ul>
        <li><code>msg.payload</code> : the item object (name, label, state, ...)</li>
         <li><code>msg.payload_in</code> : copy of incoming message's payload</li>
  	</ul>
</script>
<script type="text/x-red" data-help-name="indigo-exec-action">
    <p>Executes an Indigo Action Group on an input message.</p>
	<p></p>
	<b>Configuration</b>
    <ul>
        <li><b>Name :</b> Optionally specify a name</li>
        <li><b>Controller :</b> Select the Indigo controller</li>
        <li><b>Item :</b> Optionally select the Item to address. If specified, it overrides the item specified in the incoming message.</li>
   	 </ul>
	<p></p>

	<b>Messages injected in NodeRED flows (1 channel)</b>
	The input message with addition of :
    <ul>
        <li><code>msg.payload</code> : the item object (name, label, state, ...)</li>
         <li><code>msg.payload_in</code> : copy of incoming message's payload</li>
  	</ul>
</script>





<script type="text/javascript">
	RED.nodes.registerType('indigo-controller', {
		category: 'config',
		defaults: {
			name: {value:"",required:true},
			protocol: {value:"http",required:true},
			host: {value:"localhost",required:true},
			port: {value:8176,	required:false /*,	validate:RED.validators.number() */},
		
		    username: {value:"", required:false},
		    password:  {value:"", required:false}
		},
		label: function() {
			return this.name;
		}
	});
</script>


<script type="text/javascript">
	// some code chared by indigo-in and indigo-out
	
	function indigoEditPrepare(node, allowEmpty, itemType) {

    	function updateIndigoItemSelection(cntrlConfig, itemName, itemType) {

    		var itemSelectionEl = $('#node-input-itemname');

            itemSelectionEl.children().remove();

            if ( cntrlConfig ) {
            	var config = {
           			name: cntrlConfig.name,
           			protocol: cntrlConfig.protocol,
           			host: cntrlConfig.host,
           			port: cntrlConfig.port,
           			username: cntrlConfig.username,
           			password: cntrlConfig.password
                }
              
                console.log("config = " + JSON.stringify(config));
                
                $.getJSON("indigo/" + itemType + "s", config)
                  .done( function(data) {

                	 itemSelectionEl.children().remove();
                     var items = data;

                     items.sort(function(a,b) {
                    	 if ( a.name < b.name )
                    		 return -1;
                    	 else if ( a.name > b.name )
                    		 return 1;
                    	 else
                    		 return 0;
                     });
                     if ( allowEmpty )
                    	 itemSelectionEl.append('<option value=""></option>');
                     items.forEach(function(item) {
                    	 itemSelectionEl.append('<option>' + item.name + '</option>');
 							var it = itemSelectionEl.find('option').last();
 							it.attr('value', item.name);
                    		});
                     itemSelectionEl.val(itemName);
                  })
                  .fail(function(e1, e2, e3) {
                   
                    console.log("error : " + JSON.stringify(e1));
                  });
            }
		}

    	updateIndigoItemSelection(RED.nodes.node(node.controller), node.itemname, itemType);

		$('#node-input-controller').change(function(ev) {
	        updateIndigoItemSelection(RED.nodes.node($('#node-input-controller').val()), $('#node-input-').val() || node.itemname, itemType);
		});


	}
</script>

<script type="text/javascript">
    RED.nodes.registerType('indigo-get-device',{
        category: 'home automation',
        color: '#d0adff',
        defaults: {
            name:      {value:""},
		    controller:  {value:"", type:"indigo-controller", required:true},
		    itemname:  {value:"", required:false},
        },
        inputs: 1,
        outputs: 1,
        icon: "node-red-contrib-indigo.png",
        label: function() {

            return(this.name||this.itemname||"indigo get device");
        },
        oneditprepare: function() {
        	indigoEditPrepare(this, true,'device');
        }
    });
</script>

<script type="text/javascript">
    RED.nodes.registerType('indigo-get-variable',{
        category: 'home automation',
        color: '#d0adff',
        defaults: {
            name:      {value:""},
		    controller:  {value:"", type:"indigo-controller", required:true},
		    itemname:  {value:"", required:false},
        },
        inputs: 1,
        outputs: 1,
        icon: "node-red-contrib-indigo.png",
        label: function() {

            return(this.name||this.itemname||"indigo get variable");
        },
        oneditprepare: function() {
        	indigoEditPrepare(this, true,'variable');
        }
    });
</script>

<script type="text/javascript">
    RED.nodes.registerType('indigo-exec-action',{
        category: 'home automation',
        color: '#d0adff',
        defaults: {
            name:      {value:""},
		    controller:  {value:"", type:"indigo-controller", required:true},
		    itemname:  {value:"", required:false},
        },
        inputs: 1,
        outputs: 1,
        icon: "node-red-contrib-indigo.png",
        label: function() {

            return(this.name||this.itemname||"indigo exec action");
        },
        oneditprepare: function() {
        	indigoEditPrepare(this, true,'action');
        }
    });
</script>
<script type="text/javascript">
    RED.nodes.registerType('indigo-set-device',{
        category: 'home automation',
        color: '#d0adff',
        defaults: {
            name:      {value:""},
		    controller:  {value:"", type:"indigo-controller", required:true},
            itemname:  {value:"", required:false},
            key:      {value:"isOn"},
        },
        inputs: 1,
        outputs: 1,
        icon: "node-red-contrib-indigo.png",
        label: function() {

            return(this.name||this.itemname||"indigo set device");
        },
        oneditprepare: function() {
        	indigoEditPrepare(this, true,'device');
        }
    });
</script>

<script type="text/javascript">
    RED.nodes.registerType('indigo-set-variable',{
        category: 'home automation',
        color: '#d0adff',
        defaults: {
            name:      {value:""},
		    controller:  {value:"", type:"indigo-controller", required:true},
		    itemname:  {value:"", required:false},
        },
        inputs: 1,
        outputs: 1,
        icon: "node-red-contrib-indigo.png",
        label: function() {

            return(this.name||this.itemname||"indigo set variable");
        },
        oneditprepare: function() {
        	indigoEditPrepare(this, true,'variable');
        }
    });
</script>
